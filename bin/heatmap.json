{
  "$schema": "https://vega.github.io/schema/vega/v5.json",
  "background": "white",
  "padding": 5,
  "style": "cell",
  "data": [
    {
      "name": "kraken_csv",
      "values": "replace_me",
      "format": {"type": "csv", "delimiter": ","},
      "transform": [
        {
          "type": "filter",
          "expr": "(readSelector == 'direct' && datum.score<=maxScore && datum.score>=minScore && datum.case_max_read_count>=minReadCount &&(!rankSelector || datum.simple_taxon_rank == rankSelector)) || (readSelector == 'downstream' && datum.clade_score<=maxScore && datum.clade_score>=minScore && datum.clade_case_max_read_count>=minReadCount &&(!rankSelector || datum.simple_taxon_rank == rankSelector))"
        }
      ]
    },
    {
      "name": "data_1",
      "source": "source_0",
      "transform": [
        {
          "type": "filter",
          "expr": "isValid(datum[\"num_reads\"]) && isFinite(+datum[\"num_reads\"])"
        }
      ]
    },
    {
      "name": "data_2",
      "source": "source_0",
      "transform": [
        {
          "type": "filter",
          "expr": "isValid(datum[\"num_clade_reads\"]) && isFinite(+datum[\"num_clade_reads\"])"
        }
      ]
    }
  ],
  "signals": [
    {"name": "x_step", "value": 20},
    {"name": "width", "update": "bandspace(domain('x').length, 0, 0) * x_step"},
    {"name": "y_step", "value": 20},
    {
      "name": "height",
      "update": "bandspace(domain('y').length, 0, 0) * y_step"
    },
    {
      "name": "rankSelector",
      "bind": {
        "input": "select",
        "options": [null, "D", "K", "P", "C", "O", "F", "G", "S"],
        "labels": [
          "Show All",
          "Domain",
          "Kingdom",
          "Phylum",
          "Class",
          "Order",
          "Family",
          "Genus",
          "Species"
        ],
        "name": "Taxon Rank:"
      }
    },
    {
      "name": "readSelector",
      "bind": {
        "input": "select",
        "options": ["downstream", "direct"],
        "labels": ["downstream", "direct"],
        "name": "Include read counts for taxon that are:"
      }
    },
    {
      "name": "minScore",
      "value": 0.8,
      "bind": {
        "input": "range",
        "min": -1,
        "max": 1,
        "step": 0.1,
        "name": "Min score: "
      }
    },
    {
      "name": "maxScore",
      "value": 1,
      "bind": {
        "input": "range",
        "min": -1,
        "max": 1,
        "step": 0.1,
        "name": "Max score: "
      }
    },
    {
      "name": "minReadCount",
      "value": 5,
      "bind": {
        "input": "range",
        "min": 0,
        "max": 100,
        "step": 1,
        "name": "Min read count: "
      }
    }
  ],
  "marks": [
    {
      "name": "layer_0_marks",
      "type": "rect",
      "style": ["rect"],
      "from": {"data": "data_1"},
      "encode": {
        "update": {
          "fill": [
            {"test": "readSelector == 'downstream'", "value": null},
            {"scale": "color", "field": "num_reads"}
          ],
          "tooltip": {
            "signal": "{\"taxon\": isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"], \"taxon_ncbi\": isValid(datum[\"taxon_ncbi\"]) ? datum[\"taxon_ncbi\"] : \"\"+datum[\"taxon_ncbi\"], \"taxon_rank\": isValid(datum[\"taxon_rank\"]) ? datum[\"taxon_rank\"] : \"\"+datum[\"taxon_rank\"], \"sample\": isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"], \"num_reads\": format(datum[\"num_reads\"], \"\"), \"num_clade_reads\": format(datum[\"num_clade_reads\"], \"\"), \"score\": format(datum[\"score\"], \"\"), \"clade_score\": format(datum[\"clade_score\"], \"\"), \"case_frequency\": format(datum[\"case_frequency\"], \"\"), \"control_frequency\": format(datum[\"control_frequency\"], \"\"), \"clade_case_frequency\": format(datum[\"clade_case_frequency\"], \"\"), \"clade_control_frequency\": format(datum[\"clade_control_frequency\"], \"\")}"
          },
          "description": {
            "signal": "\"Sample: \" + (isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"]) + \"; Taxon: \" + (isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"]) + \"; Count of Reads: \" + (format(datum[\"num_reads\"], \"\")) + \"; taxon: \" + (isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"]) + \"; taxon_ncbi: \" + (isValid(datum[\"taxon_ncbi\"]) ? datum[\"taxon_ncbi\"] : \"\"+datum[\"taxon_ncbi\"]) + \"; taxon_rank: \" + (isValid(datum[\"taxon_rank\"]) ? datum[\"taxon_rank\"] : \"\"+datum[\"taxon_rank\"]) + \"; sample: \" + (isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"]) + \"; num_reads: \" + (format(datum[\"num_reads\"], \"\")) + \"; num_clade_reads: \" + (format(datum[\"num_clade_reads\"], \"\")) + \"; score: \" + (format(datum[\"score\"], \"\")) + \"; clade_score: \" + (format(datum[\"clade_score\"], \"\")) + \"; case_frequency: \" + (format(datum[\"case_frequency\"], \"\")) + \"; control_frequency: \" + (format(datum[\"control_frequency\"], \"\")) + \"; clade_case_frequency: \" + (format(datum[\"clade_case_frequency\"], \"\")) + \"; clade_control_frequency: \" + (format(datum[\"clade_control_frequency\"], \"\"))"
          },
          "x": {"scale": "x", "field": "sample"},
          "width": {"signal": "max(0.25, bandwidth('x'))"},
          "y": {"scale": "y", "field": "taxon"},
          "height": {"signal": "max(0.25, bandwidth('y'))"}
        }
      }
    },
    {
      "name": "layer_1_marks",
      "type": "rect",
      "style": ["rect"],
      "from": {"data": "source_0"},
      "encode": {
        "update": {
          "fill": [
            {
              "test": "readSelector == 'direct' && datum['num_reads'] == 0",
              "value": "white"
            },
            {"value": null}
          ],
          "tooltip": {
            "signal": "{\"taxon\": isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"], \"taxon_ncbi\": isValid(datum[\"taxon_ncbi\"]) ? datum[\"taxon_ncbi\"] : \"\"+datum[\"taxon_ncbi\"], \"taxon_rank\": isValid(datum[\"taxon_rank\"]) ? datum[\"taxon_rank\"] : \"\"+datum[\"taxon_rank\"], \"sample\": isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"], \"num_reads\": format(datum[\"num_reads\"], \"\"), \"num_clade_reads\": format(datum[\"num_clade_reads\"], \"\"), \"score\": format(datum[\"score\"], \"\"), \"clade_score\": format(datum[\"clade_score\"], \"\"), \"case_frequency\": format(datum[\"case_frequency\"], \"\"), \"control_frequency\": format(datum[\"control_frequency\"], \"\"), \"clade_case_frequency\": format(datum[\"clade_case_frequency\"], \"\"), \"clade_control_frequency\": format(datum[\"clade_control_frequency\"], \"\")}"
          },
          "description": {
            "signal": "\"Sample: \" + (isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"]) + \"; Taxon: \" + (isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"]) + \"; taxon: \" + (isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"]) + \"; taxon_ncbi: \" + (isValid(datum[\"taxon_ncbi\"]) ? datum[\"taxon_ncbi\"] : \"\"+datum[\"taxon_ncbi\"]) + \"; taxon_rank: \" + (isValid(datum[\"taxon_rank\"]) ? datum[\"taxon_rank\"] : \"\"+datum[\"taxon_rank\"]) + \"; sample: \" + (isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"]) + \"; num_reads: \" + (format(datum[\"num_reads\"], \"\")) + \"; num_clade_reads: \" + (format(datum[\"num_clade_reads\"], \"\")) + \"; score: \" + (format(datum[\"score\"], \"\")) + \"; clade_score: \" + (format(datum[\"clade_score\"], \"\")) + \"; case_frequency: \" + (format(datum[\"case_frequency\"], \"\")) + \"; control_frequency: \" + (format(datum[\"control_frequency\"], \"\")) + \"; clade_case_frequency: \" + (format(datum[\"clade_case_frequency\"], \"\")) + \"; clade_control_frequency: \" + (format(datum[\"clade_control_frequency\"], \"\"))"
          },
          "x": {"scale": "x", "field": "sample"},
          "width": {"signal": "max(0.25, bandwidth('x'))"},
          "y": {"scale": "y", "field": "taxon"},
          "height": {"signal": "max(0.25, bandwidth('y'))"}
        }
      }
    },
    {
      "name": "layer_2_marks",
      "type": "rect",
      "style": ["rect"],
      "from": {"data": "data_2"},
      "encode": {
        "update": {
          "fill": [
            {"test": "readSelector == 'direct'", "value": null},
            {"scale": "color", "field": "num_clade_reads"}
          ],
          "tooltip": {
            "signal": "{\"taxon\": isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"], \"taxon_ncbi\": isValid(datum[\"taxon_ncbi\"]) ? datum[\"taxon_ncbi\"] : \"\"+datum[\"taxon_ncbi\"], \"taxon_rank\": isValid(datum[\"taxon_rank\"]) ? datum[\"taxon_rank\"] : \"\"+datum[\"taxon_rank\"], \"sample\": isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"], \"num_reads\": format(datum[\"num_reads\"], \"\"), \"num_clade_reads\": format(datum[\"num_clade_reads\"], \"\"), \"score\": format(datum[\"score\"], \"\"), \"clade_score\": format(datum[\"clade_score\"], \"\"), \"case_frequency\": format(datum[\"case_frequency\"], \"\"), \"control_frequency\": format(datum[\"control_frequency\"], \"\"), \"clade_case_frequency\": format(datum[\"clade_case_frequency\"], \"\"), \"clade_control_frequency\": format(datum[\"clade_control_frequency\"], \"\")}"
          },
          "description": {
            "signal": "\"Sample: \" + (isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"]) + \"; Taxon: \" + (isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"]) + \"; Count of Reads: \" + (format(datum[\"num_clade_reads\"], \"\")) + \"; taxon: \" + (isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"]) + \"; taxon_ncbi: \" + (isValid(datum[\"taxon_ncbi\"]) ? datum[\"taxon_ncbi\"] : \"\"+datum[\"taxon_ncbi\"]) + \"; taxon_rank: \" + (isValid(datum[\"taxon_rank\"]) ? datum[\"taxon_rank\"] : \"\"+datum[\"taxon_rank\"]) + \"; sample: \" + (isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"]) + \"; num_reads: \" + (format(datum[\"num_reads\"], \"\")) + \"; num_clade_reads: \" + (format(datum[\"num_clade_reads\"], \"\")) + \"; score: \" + (format(datum[\"score\"], \"\")) + \"; clade_score: \" + (format(datum[\"clade_score\"], \"\")) + \"; case_frequency: \" + (format(datum[\"case_frequency\"], \"\")) + \"; control_frequency: \" + (format(datum[\"control_frequency\"], \"\")) + \"; clade_case_frequency: \" + (format(datum[\"clade_case_frequency\"], \"\")) + \"; clade_control_frequency: \" + (format(datum[\"clade_control_frequency\"], \"\"))"
          },
          "x": {"scale": "x", "field": "sample"},
          "width": {"signal": "max(0.25, bandwidth('x'))"},
          "y": {"scale": "y", "field": "taxon"},
          "height": {"signal": "max(0.25, bandwidth('y'))"}
        }
      }
    },
    {
      "name": "layer_3_marks",
      "type": "rect",
      "style": ["rect"],
      "from": {"data": "source_0"},
      "encode": {
        "update": {
          "fill": [
            {
              "test": "readSelector == 'downstream' && datum['num_clade_reads'] == 0",
              "value": "white"
            },
            {"value": null}
          ],
          "tooltip": {
            "signal": "{\"taxon\": isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"], \"taxon_ncbi\": isValid(datum[\"taxon_ncbi\"]) ? datum[\"taxon_ncbi\"] : \"\"+datum[\"taxon_ncbi\"], \"taxon_rank\": isValid(datum[\"taxon_rank\"]) ? datum[\"taxon_rank\"] : \"\"+datum[\"taxon_rank\"], \"sample\": isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"], \"num_reads\": format(datum[\"num_reads\"], \"\"), \"num_clade_reads\": format(datum[\"num_clade_reads\"], \"\"), \"score\": format(datum[\"score\"], \"\"), \"clade_score\": format(datum[\"clade_score\"], \"\"), \"case_frequency\": format(datum[\"case_frequency\"], \"\"), \"control_frequency\": format(datum[\"control_frequency\"], \"\"), \"clade_case_frequency\": format(datum[\"clade_case_frequency\"], \"\"), \"clade_control_frequency\": format(datum[\"clade_control_frequency\"], \"\")}"
          },
          "description": {
            "signal": "\"Sample: \" + (isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"]) + \"; Taxon: \" + (isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"]) + \"; taxon: \" + (isValid(datum[\"taxon\"]) ? datum[\"taxon\"] : \"\"+datum[\"taxon\"]) + \"; taxon_ncbi: \" + (isValid(datum[\"taxon_ncbi\"]) ? datum[\"taxon_ncbi\"] : \"\"+datum[\"taxon_ncbi\"]) + \"; taxon_rank: \" + (isValid(datum[\"taxon_rank\"]) ? datum[\"taxon_rank\"] : \"\"+datum[\"taxon_rank\"]) + \"; sample: \" + (isValid(datum[\"sample\"]) ? datum[\"sample\"] : \"\"+datum[\"sample\"]) + \"; num_reads: \" + (format(datum[\"num_reads\"], \"\")) + \"; num_clade_reads: \" + (format(datum[\"num_clade_reads\"], \"\")) + \"; score: \" + (format(datum[\"score\"], \"\")) + \"; clade_score: \" + (format(datum[\"clade_score\"], \"\")) + \"; case_frequency: \" + (format(datum[\"case_frequency\"], \"\")) + \"; control_frequency: \" + (format(datum[\"control_frequency\"], \"\")) + \"; clade_case_frequency: \" + (format(datum[\"clade_case_frequency\"], \"\")) + \"; clade_control_frequency: \" + (format(datum[\"clade_control_frequency\"], \"\"))"
          },
          "x": {"scale": "x", "field": "sample"},
          "width": {"signal": "max(0.25, bandwidth('x'))"},
          "y": {"scale": "y", "field": "taxon"},
          "height": {"signal": "max(0.25, bandwidth('y'))"}
        }
      }
    }
  ],
  "scales": [
    {
      "name": "x",
      "type": "band",
      "domain": {
        "fields": [
          {"data": "data_1", "field": "sample"},
          {"data": "source_0", "field": "sample"},
          {"data": "data_2", "field": "sample"}
        ],
        "sort": true
      },
      "range": {"step": {"signal": "x_step"}},
      "paddingInner": 0,
      "paddingOuter": 0
    },
    {
      "name": "y",
      "type": "band",
      "domain": {
        "fields": [
          {"data": "data_1", "field": "taxon"},
          {"data": "source_0", "field": "taxon"},
          {"data": "data_2", "field": "taxon"}
        ],
        "sort": true
      },
      "range": {"step": {"signal": "y_step"}},
      "paddingInner": 0,
      "paddingOuter": 0
    },
    {
      "name": "color",
      "type": "linear",
      "domain": [0, 1000],
      "range": "heatmap",
      "interpolate": "hcl",
      "zero": true
    }
  ],
  "axes": [
    {
      "scale": "x",
      "orient": "bottom",
      "gridScale": "y",
      "grid": true,
      "domain": false,
      "labels": false,
      "aria": false,
      "maxExtent": 0,
      "minExtent": 0,
      "ticks": false,
      "zindex": 1
    },
    {
      "scale": "y",
      "orient": "left",
      "gridScale": "x",
      "grid": true,
      "domain": false,
      "labels": false,
      "aria": false,
      "maxExtent": 0,
      "minExtent": 0,
      "ticks": false,
      "zindex": 1
    },
    {
      "scale": "x",
      "orient": "bottom",
      "grid": false,
      "title": "Sample",
      "labelOffset": 4,
      "labelPadding": 0,
      "labelAlign": "right",
      "labelAngle": 270,
      "labelBaseline": "middle",
      "zindex": 1
    },
    {
      "scale": "y",
      "orient": "left",
      "grid": false,
      "title": "Taxon",
      "zindex": 1
    }
  ],
  "legends": [
    {
      "direction": "horizontal",
      "gradientLength": 120,
      "title": "Count of Reads",
      "fill": "color"
    }
  ],
  "config": {
    "axis": {"grid": true, "tickBand": "extent"},
    "legend": {"orient": "right", "layout": {"right": {"anchor": "top"}}}
  }
}